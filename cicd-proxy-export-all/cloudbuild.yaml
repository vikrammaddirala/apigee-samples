steps:
  - name: 'gcr.io/cloud-builders/gcloud'
    id: List Proxies
    entrypoint: bash
    args:
      - -c
      - |
        export ORG_NAME="apigee-x-379708"
        export DEV_ENV_NAME="default-dev"
        export UAT_ENV_NAME="test-env"
        echo "Listing proxies in $DEV_ENV_NAME environment..."

        # List proxies in the default-dev environment
        PROXIES=$(curl -s -X GET "https://apigee.googleapis.com/v1/organizations/$ORG_NAME/environments/$DEV_ENV_NAME/apis" \
          -H "Authorization: Bearer $(gcloud auth print-access-token)")

        echo "Proxies fetched:"
        echo "$PROXIES"

        # Save proxies to a file for further processing
        echo "$PROXIES" > proxies.json

  - name: 'ubuntu'
    id: Install JQ and Process Proxies
    entrypoint: bash
    args:
      - -c
      - |
        apt-get update && apt-get install -y jq

        echo "Processing proxy list..."

        # Read proxies.json file and process with jq
        cat proxies.json | jq '.'

        # Example: Extract the proxy names
        PROXY_NAMES=$(cat proxies.json | jq -r '.[]')
        echo "Proxy names extracted:"
        echo "$PROXY_NAMES"

        # Save the processed proxy names to a file
        echo "$PROXY_NAMES" > proxy_names.txt

  - name: 'gcr.io/cloud-builders/gcloud'
    id: Download Proxies
    entrypoint: bash
    args:
      - -c
      - |
        echo "Downloading proxy bundles from $DEV_ENV_NAME environment..."

        # Download proxy bundles for each proxy in proxy_names.txt
        while IFS= read -r proxy; do
          echo "Downloading proxy: $proxy"
          curl -s -X GET "https://apigee.googleapis.com/v1/organizations/$ORG_NAME/apis/$proxy/revisions/latest?format=bundle" \
            -H "Authorization: Bearer $(gcloud auth print-access-token)" \
            -o "${proxy}.zip"
        done < proxy_names.txt

  - name: 'gcr.io/cloud-builders/gcloud'
    id: Deploy Proxies to Test Environment
    entrypoint: bash
    args:
      - -c
      - |
        echo "Deploying proxies to $UAT_ENV_NAME environment..."

        # Deploy each proxy to the test-env environment
        while IFS= read -r proxy; do
          echo "Deploying proxy: $proxy"
          curl -X POST "https://apigee.googleapis.com/v1/organizations/$ORG_NAME/environments/$UAT_ENV_NAME/apis/$proxy/revisions/latest/deployments" \
            -H "Authorization: Bearer $(gcloud auth print-access-token)" \
            -H "Content-Type: application/json" \
            -d '{}'
        done < proxy_names.txt

images:
  - gcr.io/cloud-builders/gcloud
  - ubuntu:latest

timeout: "3600s"
