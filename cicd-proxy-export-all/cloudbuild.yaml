steps:
  # Step 1: Read proxies.json and export and deploy each proxy
  - name: 'gcr.io/cloud-builders/gcloud'
    id: export-deploy
    entrypoint: 'bash'
    args:
      - -c
      - |
        # Read the JSON file from the repository
        proxies=$(cat /workspace/cicd-proxy-export-all/proxy-list/proxies.json | jq -r '.proxies[]')

        for proxy in $proxies; do
          echo "Processing proxy: $proxy"

          # Export the proxy
          gcloud apigee apis export $proxy --environment=default-dev --zip-file=/workspace/$proxy.zip

          # Deploy to test environment
          gcloud apigee apis import --name=$proxy --file=/workspace/$proxy.zip
          gcloud apigee apis deploy --name=$proxy --environment=test-env
        done

# Define substitutions (modify as needed)
substitutions:
  _ENV: 'default-dev'
  _TARGET_ENV: 'test-env'

# Define timeout (optional)
timeout: '1200s'
